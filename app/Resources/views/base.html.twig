<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>{% block title %}ABC - POS{% endblock %}</title>
        {% block stylesheets %}
			<meta charset="utf-8">
			<meta http-equiv="X-UA-Compatible" content="IE=edge">
			<meta name="viewport" content="width=device-width, initial-scale=1">
			<meta name="description" content="">
			<meta name="author" content="">
		    <!-- Bootstrap Core CSS -->
			<link href="{{ asset('vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">

			<!-- MetisMenu CSS -->
			<link href="{{ asset('vendor/metisMenu/metisMenu.min.css') }}" rel="stylesheet">

			<!-- notiny CSS -->
			<link href="{{ asset('notiny/notiny.min.css') }}" rel="stylesheet">

			<!-- Custom CSS -->
			<link href="{{ asset('dist/css/sb-admin-2.css') }}" rel="stylesheet">
			<link href="{{ asset('css/pos.css') }}" rel="stylesheet">

			<!-- Morris Charts CSS -->
			<link href="{{ asset('vendor/morrisjs/morris.css') }}" rel="stylesheet">

		    <!-- DataTables CSS -->
		    <link href="{{ asset('vendor/datatables-plugins/dataTables.bootstrap.css') }}" rel="stylesheet">

		    <!-- DataTables Responsive CSS -->
		    <link href="{{ asset('vendor/datatables-responsive/dataTables.responsive.css') }}" rel="stylesheet">

			<!-- Custom Fonts -->
			<link href="{{ asset('vendor/font-awesome/css/font-awesome.min.css') }}" rel="stylesheet" type="text/css">

			<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
			<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
			<!--[if lt IE 9]>
				<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
				<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
			<![endif]-->
		{% endblock %}
        <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}" />
    </head>
    <body>
        {% block body %}
		     <div id="wrapper">
				{{ include('templates/nav.html.twig') }}			 
			 </div>
		{% endblock %}
        {% if data.systSetting is defined %}
            {% set limitRows = data.systSetting.rowsPerPage %}
        {% else %}
            {% set limitRows = '20' %}
        {% endif %}

        {% block javascripts %}	{% endblock %}   
		    <!-- jQuery -->
			<script src="{{ asset('vendor/jquery/jquery.min.js') }}"></script>

			<!-- Bootstrap Core JavaScript -->
			<script src="{{ asset('vendor/bootstrap/js/bootstrap.min.js') }}"></script>

			<!-- Metis Menu Plugin JavaScript -->
			<script src="{{ asset('vendor/metisMenu/metisMenu.min.js') }}"></script>

			<!-- Notification javascript - notiny -->
			<script src="{{ asset('notiny/notiny.min.js') }}"></script>

			<!-- Morris Charts JavaScript -->
			<script src="{{ asset('vendor/raphael/raphael.min.js') }}"></script>
			<script src="{{ asset('vendor/morrisjs/morris.min.js') }}"></script>
			{# <script src="{{ asset('data/morris-data.js') }}"></script>
			#}
			<!-- Custom Theme JavaScript -->
			<script src="{{ asset('dist/js/sb-admin-2.js') }}"></script>
			
	 	   <!-- DataTables JavaScript -->
		    <script src="{{ asset('vendor/datatables/js/jquery.dataTables.min.js') }}"></script>
		    <script src="{{ asset('vendor/datatables-plugins/dataTables.bootstrap.min.js') }}"></script>
		    <script src="{{ asset('vendor/datatables-responsive/dataTables.responsive.js') }}"></script>

		<!-- Keyboard Shortcut Javascript -->
			<script src="{{ asset('js/shortcut.js') }}"></script>

			<script>
			window.onload=loadShortcuts;
            $('#valueHolder').focus();
			$("input[type='text']").focus(function () {
			   $(this).select();
			});
			</script>
		    <script>
		    $(document).ready(function() {
		        $('#niceTable').DataTable({
		            responsive: true,
                "pageLength": "{{limitRows}}",
		        });
		    });
		    </script>

			<script>
			var xTriggered = 0;
			$( "#searchItem" ).keyup(function( event ) {
			  xTriggered++;
			  var msg = "Handler for .keyup() called " + xTriggered + " time(s).";
			  console.log(msg);
			  var value = $(this).val();
			  console.log(value);
			  var id = jQuery(this).attr("id");
			    $.ajax({
			        url:'{{ (path('get_matches')) }}',
			        type: "POST",
			        dataType: "json",
			        data: {
			            "thisValue": value,
			        },
			        async: true,
			        success: function (data)
			        {
			            console.log(data)
			            $('.result').text(data.output.product);
			            $('.result').attr('id', 'ajax_'+data.output.id);
			            if ( event.which == 13 ) {
						    //$('#ajax_'+data.output.id).click();
						    console.log('from#ajax_'+data.output.id);
						    return false;
						    $('#searchItem').val('');
						}
			        }
			    });

			});
			</script>
			{% for message in app.flashes('success') %}
				<script type="text/javascript">
					$.notiny({ text: '{{ message }}' });
				</script>
			{% endfor %}

    <script>
        $(document).on('click', '[id^="ajax_"]', function(){
            that = $(this);
            var id = jQuery(this).attr("id");
            $.ajax({
                url:'{{ (path('ajax_request')) }}',
                type: "POST",
                dataType: "json",
                data: {
                    "some_var_name": id,
                },
                async: true,
                success: function (data)
                {
                    console.log(data.output)
                    $('#sales > tbody:last-child').append(data.output);
                    $('#tableToArray').click();
                }
            });
            return false;

        });
    </script>

	  <script>
        $(document).on('click', '[id^="Cl_"]', function(){
            that = $(this);
            var id = jQuery(this).attr("id");
            $.ajax({
                url:'{{ (path('remove_request')) }}',
                type: "POST",
                dataType: "json",
                data: {
                    "some_var_name": id,
                },
                async: true,
                success: function (data)
                {
                    console.log(data)
                    $('#Rw_'+data).remove();
                    // $("#sales > tbody:nth-child("+data+")").remove();
                    $('#tableToArray').click();
                }
            });
            return false;

        });
    </script>
    <script>
        $(document).on('keypress', '#searchItem', function(e){
           var key = e.which;
           if(key == 13){ 
            var code = $(this).val();
            $.ajax({
                url:'{{ (path('ajax_request_search')) }}',
                type: "POST",
                dataType: "json",
                data: {
                    "code": code,
                },
                async: true,
                success: function (data)
                {
                    console.log("ajaxSearch"+data.output)
                    $('#sales > tbody:last-child').append(data.output);
                    $('#searchItem').val('');                    
                    $('#tableToArray').click();
                }
            });
            return false;
          }
        });

    </script>
    <script>
    $(document).on("click", '[id^="Qt_"]', function(){
      var value = $(this).text();
      var id = jQuery(this).attr("id");
        $.ajax({
            url:'{{ (path('get_value')) }}',
            type: "POST",
            dataType: "json",
            data: {
                "thisValue": value,
            },
            async: true,
            success: function (data)
            {
                console.log(data)
                $("#changeValueModal").modal('show');
                $('#valueHolder').val(data.output);
                $("#valueHolder").removeClass (function (index, className) {
                    return (className.match (/(^|\s)changeRow_Qt_\S+/g) || []).join(' ');
                });
                $('#valueHolder').addClass('changeRow_'+id);
                $('#valueHolder').focus().select();
                $('#tableToArray').click();
            }
        });
        
      $('#searchItem').focus();      
    });
  </script>
  <script>
    $(document).on("change", '#valueHolder', function(){
      var classNames = $("#valueHolder").attr("class").toString().split(' ');
      var thirdClass = classNames[2];
      var newValue = $("#valueHolder").val();

      var thirdClassArray = thirdClass.split('_'); //changeRow_Qt_1504
      var id = thirdClassArray[2] //1504

      var price = $("#Pr_"+id).text();
      var total = $("#Tl_"+id);
      var qty = $("#Qt_"+id);
      qty.text(newValue);
      total.text(price*newValue)

      $("#changeValueModal").modal('hide');
      $('#searchItem').focus(); 
      $('#tableToArray').click();     
    });
  </script>
  <script>
    $( "#tableToArray" ).click(function() {
      var $table = $("#sales");
      $rowCells = $table.find("tbody tr td");
      $rowFull = $table.find("tbody tr");
      
      var rows = [];
      var raws = [];

      $rowCells.each(function(k,v) {
         rows[rows.length] = $(this).text();
      });
      
      $rowFull.each(function(k,v) {
         raws[raws.length] = $(this).attr('id');
      });
      
      $.ajax({
            url:'{{ (path('get_additions')) }}',
            type: "POST",
            dataType: "json",
            data: {
                "rows": rows,
                "raws": raws,
            },
            async: true,
            success: function (data)
            {
              // console.log("row:");
              // console.log(data.output.chunks);
              $("#amountDue").text(data.output.totalSum);
              $("#show_tax").text(data.output.tax);
              $("#show_qty").text(data.output.qtySum);
              var arrayLength = data.output.chunks.length;

              var stock = new Array();
              $("#salesRow").closest("tbody").html("");
              for (var i = 0; i < arrayLength; i++) {
                  stock.push(data.output.chunks[i]);
                  var oneRow = data.output.chunks[i];
                  var row = '<tr id="salesRow"><td class="col-md-9"><em>'+oneRow[1]+'</em></td><td class="col-md-1" style="text-align: center">'+oneRow[3]+'</td><td class="col-md-1 text-center">'+oneRow[2]+'</td><td class="col-md-1 text-center">'+oneRow[4]+'</td></tr>';
                  $('#receiptTable > tbody:first').append(row);

              }
            }
        });

      });
  </script>
  <script type="text/javascript">
      $( "#paidAmt" ).keyup(function(event) {
        var value = $(this).val();
        var amountDue = $("#amountDue").text();
        var difference = parseInt(value)-parseInt(amountDue);
        if(difference >= 0){
          $("#show_bal").text(difference);
        }
        console.log("diff:"+difference);
      });

  </script>
  <script type="text/javascript">
  shortcut.add("F4", function() {
      var paidAmt =    $("#paidAmt").val();
      if($("#paidAmt").val()==""){
        $("#infoParagraph").html("<span class='text-danger'>Please indicate how much has been paid?</span><br />Hit F7 to focus");
        $("#infoModal").modal('show');

      } else {
            var qtyTotal = $("#show_qty").text();
            var total = $("#amountDue").text();
            var tax = $("#show_tax").text();
            if($("#creditCardInput").val() != ""){
              var creditCard = $("#creditCardInput").val();
              var paymentMode = "creditCard";
            } else {
              var creditCard = 0;
            } 
            if($("#mpesaInput").val() != "") {
              var mpesa = $("#mpesaInput").val();
              var paymentMode = "mpesa";
            } else {
              var mpesa = 0;
            }
            if($("#checkInput").val() != "") {
              var check = $("#checkInput").val();
              var paymentMode = "check";
            } else {
              var check = 0;
            }

              $.ajax({
              type: "POST",
              url: '{{ (path('save_sale')) }}',
              data: {
                'qtyTotal': qtyTotal,
                'total': total,
                'tax': tax,
                'mpesa': mpesa,
                'check': check,
                'creditCard': creditCard,
                'paymentMode': paymentMode,
              },
              async: true,
              success: function (data) 
              {
                //console.log("fromAjax"+data.output);
                $("#receiptTotal").html('<strong>' + $("#amountDue").text() +'</strong>');              
                $("#receiptPaid").html('<strong>' + $("#paidAmt").val() +'</strong>');              
                $("#receiptChange").html('<strong>' + $("#show_bal").text() +'</strong>');              
                $("#receiptModal").modal('show'); 

                var $table = $("#sales");
                $rowCells = $table.find("tbody tr td");
                $rowFull = $table.find("tbody tr");
                
                var rows = [];
                var raws = [];

                $rowCells.each(function(k,v) {
                   rows[rows.length] = $(this).text();
                });
                
                $rowFull.each(function(k,v) {
                   raws[raws.length] = $(this).attr('id');
                });
                
                $.ajax({
                      url:'{{ (path('get_additions')) }}',
                      type: "POST",
                      dataType: "json",
                      data: {
                          "rows": rows,
                          "raws": raws,
                      },
                      async: true,
                      success: function (data)
                      {
                        var arrayLength = data.output.chunks.length;
                        var stock = new Array();
                        for (var i = 0; i < arrayLength; i++) {                          
                            data.output.chunks[i].splice(0, 1, data.output.products[i]);
                            stock.push(data.output.chunks[i]);
                        }
                        var stockString = JSON.stringify(stock);
                          $.ajax({
                          url:'{{ (path('save_stock')) }}',
                          type: "POST",
                          dataType: "json",
                          data: {
                              "stock": stock,
                          },
                          async: true,
                          success: function (data)
                          {
                            console.log("fromAjax: "+data.output);
                          }
                        });

                      }
                  });

            }
        });
      }
  });

  </script>
  <script type="text/javascript">
  $(document).on('keypress', '#paidAmt', function(e){  
      var key = e.which;
      if(key == 13) {
      var paidAmt =    $("#paidAmt").val();
      if($("#paidAmt").val()==""){
        $("#infoParagraph").html("<span class='text-danger'>Please indicate how much has been paid?</span><br />Hit F7 to focus");
        $("#infoModal").modal('show');

      } else {
            var qtyTotal = $("#show_qty").text();
            var total = $("#amountDue").text();
            var tax = $("#show_tax").text();
            if($("#creditCardInput").val() != ""){
              var creditCard = $("#creditCardInput").val();
              var paymentMode = "creditCard";
            } else {
              var creditCard = 0;
            } 
            if($("#mpesaInput").val() != "") {
              var mpesa = $("#mpesaInput").val();
              var paymentMode = "mpesa";
            } else {
              var mpesa = 0;
            }
            if($("#checkInput").val() != "") {
              var check = $("#checkInput").val();
              var paymentMode = "check";
            } else {
              var check = 0;
            }

              $.ajax({
              type: "POST",
              url: '{{ (path('save_sale')) }}',
              data: {
                'qtyTotal': qtyTotal,
                'total': total,
                'tax': tax,
                'mpesa': mpesa,
                'check': check,
                'creditCard': creditCard,
                'paymentMode': paymentMode,
              },
              async: true,
              success: function (data) 
              {
                //console.log("fromAjax"+data.output);
                $("#receiptTotal").html('<strong>' + $("#amountDue").text() +'</strong>');              
                $("#receiptPaid").html('<strong>' + $("#paidAmt").val() +'</strong>');              
                $("#receiptChange").html('<strong>' + $("#show_bal").text() +'</strong>');              
                $("#receiptModal").modal('show'); 

                var $table = $("#sales");
                $rowCells = $table.find("tbody tr td");
                $rowFull = $table.find("tbody tr");
                
                var rows = [];
                var raws = [];

                $rowCells.each(function(k,v) {
                   rows[rows.length] = $(this).text();
                });
                
                $rowFull.each(function(k,v) {
                   raws[raws.length] = $(this).attr('id');
                });
                
                $.ajax({
                      url:'{{ (path('get_additions')) }}',
                      type: "POST",
                      dataType: "json",
                      data: {
                          "rows": rows,
                          "raws": raws,
                      },
                      async: true,
                      success: function (data)
                      {
                        var arrayLength = data.output.chunks.length;
                        var stock = new Array();
                        for (var i = 0; i < arrayLength; i++) {                          
                            data.output.chunks[i].splice(0, 1, data.output.products[i]);
                            stock.push(data.output.chunks[i]);
                        }
                        var stockString = JSON.stringify(stock);
                          $.ajax({
                          url:'{{ (path('save_stock')) }}',
                          type: "POST",
                          dataType: "json",
                          data: {
                              "stock": stock,
                          },
                          async: true,
                          success: function (data)
                          {
                            console.log("fromAjax: "+data.output);
                          }
                        });

                      }
                  });

            }
        });
      }
    }
  });

  </script>
  <script type="text/javascript">
  $(document).on('click', '#suspendSale', function(e){ 

      var paidAmt =    $("#paidAmt").val();
      if($("#amountDue").text()==""){
        $("#infoParagraph").html("<span class='text-danger'>No sale exists to cancel?</span><br />Hit F7 to focus");
        $("#infoModal").modal('show');

      } else {
            var qtyTotal = $("#show_qty").text();
            var total = $("#amountDue").text();
            var tax = $("#show_tax").text();
            if($("#creditCardInput").val() != ""){
              var creditCard = $("#creditCardInput").val();
              var paymentMode = "creditCard";
            } else {
              var creditCard = 0;
            } 
            if($("#mpesaInput").val() != "") {
              var mpesa = $("#mpesaInput").val();
              var paymentMode = "mpesa";
            } else {
              var mpesa = 0;
            }
            if($("#checkInput").val() != "") {
              var check = $("#checkInput").val();
              var paymentMode = "check";
            } else {
              var check = 0;
            }

              $.ajax({
              type: "POST",
              url: '{{ (path('save_sale')) }}',
              data: {
                'qtyTotal': qtyTotal,
                'total': total,
                'tax': tax,
                'mpesa': mpesa,
                'check': check,
                'creditCard': creditCard,
                'suspended': "suspended",
                'paymentMode': paymentMode,
              },
              async: true,
              success: function (data) 
              {
                //console.log("fromAjax"+data.output);
                $("#receiptTotal").html('<strong>' + $("#amountDue").text() +'</strong>');              
                $("#receiptPaid").html('<strong>' + $("#paidAmt").val() +'</strong>');              
                $("#receiptChange").html('<strong>' + $("#show_bal").text() +'</strong>');              
                //$("#receiptModal").modal('show'); 

                var $table = $("#sales");
                $rowCells = $table.find("tbody tr td");
                $rowFull = $table.find("tbody tr");
                
                var rows = [];
                var raws = [];

                $rowCells.each(function(k,v) {
                   rows[rows.length] = $(this).text();
                });
                
                $rowFull.each(function(k,v) {
                   raws[raws.length] = $(this).attr('id');
                });
                
                $.ajax({
                      url:'{{ (path('get_additions')) }}',
                      type: "POST",
                      dataType: "json",
                      data: {
                          "rows": rows,
                          "raws": raws,
                      },
                      async: true,
                      success: function (data)
                      {
                        var arrayLength = data.output.chunks.length;
                        var stock = new Array();
                        for (var i = 0; i < arrayLength; i++) {                          
                            data.output.chunks[i].splice(0, 1, data.output.products[i]);
                            stock.push(data.output.chunks[i]);
                        }
                        var stockString = JSON.stringify(stock);
                          $.ajax({
                          url:'{{ (path('save_stock')) }}',
                          type: "POST",
                          dataType: "json",
                          data: {
                              "stock": stock,
                          },
                          async: true,
                          success: function (data)
                          {
                            console.log("fromAjax: "+data.output);
                          }
                        });

                      }
                  });

            }
        });
      }

  });

  </script>
    </body>
</html>
